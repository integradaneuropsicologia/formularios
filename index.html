<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Área do Paciente — Integrada Neuropsicologia</title>
  <meta name="description" content="Portal do paciente para acessar e preencher testes liberados."/>
  <style>
  /* ===========================
   * Variáveis e base
   * =========================== */
  :root{
    --bg:#0e1625; --card:#14213b; --line:#2b3f66;
    --text:#f8fafc; --muted:#cbd5e1;
    --pri:#6d28d9; --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
    --chip:#0b1220;

    /* Cores por respondente (mesmo padrão do painel) */
    --src-paciente:#22c55e;        /* verde */
    --src-pais:#f59e0b;            /* âmbar */
    --src-professores:#398df3;     /* azul */
    --src-familiares:#e223ff;      /* rosa */
    --src-profissional:#ff0909;    /* cinza */
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }

  .wrap{max-width:980px;margin:20px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:18px}
  .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;gap:8px}
  .brand{font-weight:700;overflow-wrap:anywhere}
  h1,h2{margin:0 0 12px}
  h2{font-size:1.05rem;color:var(--muted)}

  .btn{
    display:inline-flex;align-items:center;gap:10px;
    background:var(--pri);border:none;color:#fff;
    padding:12px 16px;border-radius:12px;cursor:pointer;font-weight:600
  }
  .btn.sec{background:#334155}
  .btn.ok{background:var(--ok)}
  .btn:disabled{opacity:.6;cursor:not-allowed}

  .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}

  .msg{margin:12px 0;padding:12px;border-radius:10px}
  .okbox{background:#06351f;border:1px solid #0e6c45;color:#c8ffe3}
  .warnbox{background:#3a2903;border:1px solid #885e09;color:#ffe6b0}
  .errbox{background:#3b0d0d;border:1px solid #7f1d1d;color:#ffd5d5}

  .hidden{display:none !important}
  .muted{ color: var(--muted); }

  /* ===========================
   * Grid de cards
   * =========================== */
  .grid{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
    gap:12px;margin-top:10px
  }
  @media (max-width:560px){ .grid{grid-template-columns:1fr} }

  .test{
    background:rgba(0,0,0,.18);
    border:1px solid var(--line);
    border-radius:12px;
    padding:12px;
    display:flex;flex-direction:column;gap:10px;min-width:0
  }

  /* Borda lateral e leve glow por respondente */
  .test.src-paciente{    border-left:6px solid var(--src-paciente);    box-shadow: inset 0 0 0 1px rgba(34,197,94,.12); }
  .test.src-pais{        border-left:6px solid var(--src-pais);        box-shadow: inset 0 0 0 1px rgba(245,158,11,.12); }
  .test.src-professores{ border-left:6px solid var(--src-professores); box-shadow: inset 0 0 0 1px rgba(96,165,250,.12); }
  .test.src-familiares{  border-left:6px solid var(--src-familiares);  box-shadow: inset 0 0 0 1px rgba(232,121,249,.12); }
  .test.src-profissional{border-left:6px solid var(--src-profissional);box-shadow: inset 0 0 0 1px rgba(148,163,184,.12); }

  /* ===========================
   * Cabeçalho do card (ordem vertical)
   * Título  → abaixo Label  → abaixo spans  → abaixo botões
   * =========================== */
  .test-head{
    display:grid;
    grid-template-columns:1fr 1fr;   /* linha 1: título+label ocupam 2 colunas */
    column-gap:12px; row-gap:6px;
    align-items:start; min-width:0;
  }
  /* O primeiro filho (wrap com título/label) ocupa as 2 colunas da primeira linha */
  .test-head > *:first-child{ grid-column:1 / -1; }

  @media (max-width:560px){
    .test-head{ grid-template-columns:1fr; }
    .test-head > *:first-child{ grid-column:auto; }
  }

  /* Título (principal) */
  .test-title{
    font-weight:700; font-size:1rem; line-height:1.35; letter-spacing:.01em;
    overflow-wrap:anywhere; word-break:break-word; min-width:0;
  }

  /* Label (linha abaixo do título) */
  .test-label{
    font-weight:400; color:var(--text); opacity:.95;
    line-height:1.35; margin-top:2px;
  }

  /* Código (se você usar) — discreto e monoespaçado */
  .test-code{
    color:var(--muted); font-size:.8rem; line-height:1.25;
    font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;
    margin-top:2px; overflow-wrap:anywhere;
  }

  /* Spans (chip de respondente + status) — ficam na linha abaixo do label */
  .srcchip, .tag{ flex-shrink:0; white-space:nowrap; }
  .srcchip{
    display:inline-flex; align-items:center; gap:6px;
    font-size:.72rem; padding:2px 8px;
    border:1px solid var(--line); border-radius:999px;
    background:var(--chip); color:var(--muted);
  }
  .srcchip::before{ content:""; width:10px; height:10px; border-radius:50%; }
  .srcchip.paciente::before{    background:var(--src-paciente); }
  .srcchip.pais::before{        background:var(--src-pais); }
  .srcchip.professores::before{ background:var(--src-professores); }
  .srcchip.familiares::before{  background:var(--src-familiares); }
  .srcchip.profissional::before{background:var(--src-profissional); }

  .tag{
    font-size:.75rem; padding:2px 8px;
    border-radius:999px; border:1px solid var(--line);
    color:#dbeafe; background:#0b3d2a; border-color:#0e6c45;
  }
  .tag.ja{ background:#0b3d2a; border-color:#0e6c45; }
  .tag.preenchido{ background:#0a2b45; border-color:#145a86; }
  .tag.aguardando{ background:#3a2903; border-color:#885e09; color:#ffe6b0; }

  /* Botões já vêm depois do head no DOM; só dá um respiro */
  .test .toolbar{ margin-top:4px; }

  /* ===========================
   * Blocos de informações do paciente
   * =========================== */
  .grid-info{
    display:grid; grid-template-columns:1fr 1fr; gap:12px; margin:12px 0 6px;
  }
  @media (max-width:720px){ .grid-info{ grid-template-columns:1fr; } }

  .info{
    background:rgba(0,0,0,.18); border:1px solid var(--line);
    border-radius:12px; padding:12px;
  }
  .info b{ display:block; margin-bottom:4px; color:#e2e8f0; }
  /* === Cards de respondentes (topo) === */
.resp-grid{
  display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:12px; margin:10px 0 6px;
}
.resp-card{
  background:rgba(0,0,0,.18); border:1px solid var(--line);
  border-radius:12px; padding:12px; display:flex; flex-direction:column; gap:10px;
}
.resp-card .title{ font-weight:700; font-size:1rem; }
.resp-card .desc{ color:var(--muted); font-size:.9rem; line-height:1.35; }
.resp-card .count{ font-size:.8rem; color:var(--muted); }

/* borda colorida por respondente */
.resp-card.src-paciente{    border-left:6px solid var(--src-paciente); }
.resp-card.src-pais{        border-left:6px solid var(--src-pais); }
.resp-card.src-professores{ border-left:6px solid var(--src-professores); }
.resp-card.src-familiares{  border-left:6px solid var(--src-familiares); }

/* botão do card com a cor do respondente */
.resp-btn{
  border:none; border-radius:10px; padding:10px 12px; font-weight:700;
  cursor:pointer; display:inline-flex; align-items:center; justify-content:center; width:100%;
}
.resp-btn.paciente{    background:var(--src-paciente); color:#05240f; }
.resp-btn.pais{        background:var(--src-pais);     color:#231a03; }
.resp-btn.professores{ background:var(--src-professores); color:#fff; }
.resp-btn.familiares{  background:var(--src-familiares);  color:#fff; }

/* caixa de orientações + legenda */
.instructions{
  background:rgba(0,0,0,.18); border:1px solid var(--line);
  border-radius:12px; padding:12px; margin-top:8px;
}
.legend{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
.legend .chip{ display:inline-flex; align-items:center; gap:6px; padding:2px 8px;
  border:1px solid var(--line); border-radius:999px; background:#0b1220; color:var(--muted); font-size:.8rem;
}
.legend .dot{ width:15px; height:15px; border-radius:50%; }
.legend .dot.paciente{    background:var(--src-paciente); }
.legend .dot.pais{        background:var(--src-pais); }
.legend .dot.professores{ background:var(--src-professores); }
.legend .dot.familiares{  background:var(--src-familiares); }

/* sub-bar dos testes filtrados */
.subbar{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin:8px 0; }
.btn-mini{ padding:8px 10px; border-radius:10px; font-size:.9rem; }

/* botões dos formulários com cor do respondente */
.btn-src-paciente{    background:var(--src-paciente) !important; color:#05240f !important; }
.btn-src-pais{        background:var(--src-pais) !important;     color:#231a03 !important; }
.btn-src-professores{ background:var(--src-professores) !important; color:#fff !important; }
.btn-src-familiares{  background:var(--src-familiares) !important;  color:#fff !important; }

/* mostra/esconde seções */
#testsSection.hidden, #respondentsSection.hidden{ display:none !important; }
/* Card "Profissional" (borda colorida) */
.resp-card.src-profissional{ border-left:6px solid var(--src-profissional); }

/* Botão do card "Profissional" */
.resp-btn.profissional{ background:var(--src-profissional); color:#fff; }

/* Ponto da legenda "Profissional" */
.legend .dot.profissional{ background:var(--src-profissional); }

/* Botão dos formulários com a cor do "Profissional" */
.btn-src-profissional{ background:var(--src-profissional) !important; color:#fff !important; }

/* Faz o bloco de orientações chamar atenção */
#respGuidance {
  border:2px solid var(--warn);
  box-shadow:0 0 10px rgba(245,158,11,.6), 0 0 30px rgba(245,158,11,.2);
  animation:pulseWarn 1.25s ease-in-out infinite;
}

@keyframes pulseWarn {
  0%,100% {
    box-shadow:0 0 10px rgba(245,158,11,.7), 0 0 30px rgba(245,158,11,.25);
  }
  50% {
    box-shadow:0 0 2px rgba(245,158,11,.2), 0 0 8px rgba(245,158,11,.05);
  }
}
.resp-btn:disabled{
  opacity:.4;
  cursor:not-allowed;
  filter:grayscale(0.4);
 
}


</style>


</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">Integrada Neuropsicologia — Área do Paciente</div>
      <div>
        <button id="btnSair" class="btn sec hidden">Sair</button>
      </div>
    </div>

    <!-- AVISOS -->
    <div id="msg" class="msg hidden"></div>

    <!-- APP -->
    <section id="viewApp" class="card hidden">
      <h1>Olá, <span id="pacNomeSpan">Paciente</span></h1>

      <!-- Dados do paciente -->
      <div class="grid-info" id="pacInfo" style="margin:10px 0 6px;"></div>

      <div class="toolbar">
        <button id="btnAtualizar" class="btn sec">Atualizar</button>
        <span id="resume" class="tag">—</span>
      </div>


 <div class="instructions" id="respGuidance">
    <b>Orientações</b>
    <div class="muted" style="margin-top:6px">
      Cada pessoa deve responder <strong>apenas</strong> os formulários com a <strong>própria cor</strong>.
     
    </div>
    <div class="legend">
      <span class="chip"><span class="dot paciente"></span> Paciente</span>
      <span class="chip"><span class="dot pais"></span> Pais/Cuidadores</span>
      <span class="chip"><span class="dot professores"></span> Professores</span>
      <span class="chip"><span class="dot familiares"></span> Familiares/Amigos</span>
      <span class="chip"><span class="dot profissional"></span> Profissional</span>
    </div>
  </div>
  


      <h2>Quem vai responder?</h2>
<div id="respondentsSection">
  <div id="sourcesGrid" class="resp-grid" aria-live="polite"></div>

     

      

  
</div>

<div id="testsSection" class="hidden">
  <div class="subbar">
    <div class="who">Formulários para: <b id="selResp">—</b></div>
    <button id="btnTrocarResp" class="btn sec btn-mini">Trocar respondente</button>
  </div>
  <div id="testsGrid" class="grid" aria-live="polite"></div>
</div>

    </section>
  </div>

<script>
/* ===========================
 * CONFIG
 * =========================== */
const SHEETDB_BASE = "https://sheetdb.io/api/v1/8pmdh33s9fvy8";
const SHEETS = { TESTS:"Tests", PATIENTS:"Patients", TOKENS:"LinkTokens" };

/* Fallbacks (se a aba Tests não trouxer URL) */
const BASE_TEST_URL = "https://integradaneuropsicologia.github.io/formularios"; // abre BASE_TEST_URL/<code>.html
const BASE_FORM_URL = "https://integradaneuropsicologia.github.io/formularios/share";

/* Mapa opcional para sobrescrever URLs por código (opcional) */
const TEST_URLS = {
  "BAI": "https://integradaneuropsicologia.github.io/formulariodeansiedade/",

  "SRS2_AUTORRELATO": "https://integradaneuropsicologia.github.io/srs2/",
  
  "SRS2_HETERORRELATO": "https://integradaneuropsicologia.github.io/SRS2_HETERORRELATO/"
};



const SHARE_URLS = {
  // "SRS2": "https://.../srs2-share.html"
};

/* Links de “Preencher” levam token; links de segunda-fonte NÃO levam token */
const APPEND_TOKEN_PARAM = true;
const DEFAULT_TARGETS = ["pais","professores","segunda_fonte","heterorrelato"];

const TEST_PREFIX = "";       // se tiver prefixo nas colunas da Patients
const DONE_SUFFIX  = "_FEITO";

let currentSource = null;           // 'paciente' | 'pais' | 'professores' | 'familiares'
let currentSourceLabel = "—";

const RESPONDENTS = [
  { cls:'paciente',     label:'Paciente',           desc:'Paciente quem deve responder.' },
  { cls:'pais',         label:'Pais/Cuidadores',    desc:'Pais/responsáveis é quem devem responder.' },
  { cls:'professores',  label:'Professores',        desc:'Professores/pedagogos quem devem responder.' },
  { cls:'familiares',   label:'Familiares/Amigos',  desc:'Familiares/amigos que o paciente escolher.' },
  { cls:'profissional', label:'Profissional',       desc:'Preenchimento reservado ao profissional que está avaliando.' },
];


/* ===========================
 * HELPERS
 * =========================== */
const $ = s => document.querySelector(s);
const el = (tag, opts={}) => Object.assign(document.createElement(tag), opts);
const onlyDigits = s => (s||"").replace(/\D+/g,"");
const qs = k => new URLSearchParams(location.search).get(k) || "";

function setMsg(text="", type="ok"){
  const b = $("#msg");
  b.textContent = text;
  b.className = "msg " + (type==="ok"?"okbox":type==="warn"?"warnbox":"errbox");
  text ? b.classList.remove("hidden") : b.classList.add("hidden");
}
async function sheetSearch(sheet, params){
  const usp = new URLSearchParams(params);
  const url = `${SHEETDB_BASE}/search?sheet=${encodeURIComponent(sheet)}&${usp.toString()}`;
  const r = await fetch(url);
  if(!r.ok) throw new Error("Falha ao buscar em "+sheet);
  return r.json();
}
function maskCPF(cpf){
  const d = onlyDigits(cpf||"");
  if(d.length!==11) return cpf||"";
  return `${d.slice(0,3)}.${d.slice(3,6)}.${d.slice(6,9)}-${d.slice(9)}`;
}
function fmtDateISO(iso){
  if(!iso) return "";
  const [y,m,d] = iso.split("-");
  return (y && m && d) ? `${d}/${m}/${y}` : iso;
}
function buildUrl(base, params){
  try{
    const u = new URL(base, location.href);
    Object.entries(params||{}).forEach(([k,v])=> u.searchParams.set(k, v));
    return u.toString();
  }catch(_){
    const q = Object.entries(params||{}).map(([k,v])=>`${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join("&");
    return base + (base.includes("?") ? "&" : "?") + q;
  }
}

/* ===========================
 * ESTADO
 * =========================== */
let TOKEN = "";
let patient = null;
let testsCatalog = []; // {code,label,order,shareable,targets,form_url,share_url}

/* ===========================
 * BOOT VIA TOKEN
 * =========================== */
(async function boot(){
  try{
    TOKEN = qs("token");
    if(!TOKEN){ setMsg("Link inválido (sem token). Solicite um novo link ao consultório.", "err"); return; }

    // 1) validar token e obter CPF
    const trows = await sheetSearch(SHEETS.TOKENS, { token: TOKEN });
    if(!trows || !trows.length) throw new Error("Token inválido ou expirado.");
    const t = trows[0];
    if(String(t.disabled||"não").toLowerCase()==="sim") throw new Error("Token desativado. Peça um novo link.");
    if(t.expires_at && new Date(t.expires_at) < new Date()) throw new Error("Token expirado. Peça um novo link.");
    const cpf = onlyDigits(t.cpf||"");
    if(!cpf) throw new Error("Token sem CPF vinculado.");

    // 2) paciente
    const prows = await sheetSearch(SHEETS.PATIENTS, { cpf });
    if(!prows || !prows.length) throw new Error("Paciente não encontrado.");
    patient = prows[0];

    // 3) catálogo de testes
    await loadTests();

    // 4) render
    $("#pacNomeSpan").textContent = patient.nome || "Paciente";
    renderPatientInfo();
    renderRespondentCards();        // mostra os 4 cards
    toggleSections(false);          // mostra respondentes, esconde testes
    $("#viewApp").classList.remove("hidden");

    $("#btnSair").classList.remove("hidden");
    setMsg(""); // apaga avisos

  }catch(e){
    console.error(e);
    setMsg(e.message || "Falha ao abrir sua área. Tente novamente mais tarde.", "err");
  }
})();

$("#btnSair").addEventListener("click", ()=>{
  // remove o token da barra e recarrega
  history.replaceState({}, "", location.pathname);
  location.reload();
});

/* ===========================
 * INFO DO PACIENTE
 * =========================== */
function renderPatientInfo(){
  const g = $("#pacInfo");
  g.innerHTML = "";
  const info = [
    ["Nome", patient.nome || "-"],
    ["Nascimento", fmtDateISO(patient.data_nascimento)],
   
  ];
  for(const [k,v] of info){
    const it = el("div",{className:"info"});
    it.innerHTML = `<b>${k}</b><div>${v||"-"}</div>`;
    g.appendChild(it);
  }
}

/* ===========================
 * TESTES
 * =========================== */
$("#btnAtualizar").addEventListener("click", async ()=>{
  if(!patient) return;
  try{
    // Recarrega dados atualizados do paciente
    const prows = await sheetSearch(SHEETS.PATIENTS, { cpf: patient.cpf });
    if(prows && prows.length) patient = prows[0];

    // Recarrega lista de testes liberados / status
    await loadTests(true);

    // Re-renderiza TANTO os cards de respondentes quanto a lista de testes atual
    renderRespondentCards();
    renderTests();

    setMsg("Atualizado.", "ok");
    setTimeout(()=>setMsg(""), 900);
  }catch(_){
    // silêncio pra não travar a UX
  }
});


async function loadTests(skipFetch){
  if(!skipFetch){
    const rows = await sheetSearch(SHEETS.TESTS, { active:"sim" });
    testsCatalog = rows.map(r=>{
  const code = (r.code||"").trim();
  const label = (r.label||code).trim();
  const order = Number(r.order||9999);
  const shareable = String(r.shareable||"não").trim().toLowerCase()==="sim";
  const targetsArr = String(r.targets||"").split(/[;,]+/).map(s=>s.trim().toLowerCase()).filter(Boolean);
  const form_url = (r.form_url||"").trim();
  const share_url = (r.share_url||"").trim();
  const source = (r.source||"paciente").trim(); // <<<<<<<<<< AQUI

  return {
    code, label, order, shareable,
    targets: (shareable ? (targetsArr.length?targetsArr:DEFAULT_TARGETS) : []),
    form_url, share_url,
    source                     // <<<<<<<<<< E AQUI
  };
})
.filter(t=>t.code).sort((a,b)=> a.order-b.order || a.label.localeCompare(b.label));
  }
  const allowed = testsCatalog.filter(t => isAllowed(t));
  const cJa  = allowed.filter(t => statusOf(t)==="ja").length;
  const cOk  = allowed.filter(t => statusOf(t)==="preenchido").length;
  $("#resume").textContent = `Liberados: ${allowed.length} • Em aberto: ${cJa} • Preenchidos: ${cOk}`;
}

function colFor(t){ return (TEST_PREFIX ? TEST_PREFIX + t.code : t.code); }
function doneColFor(t){ return colFor(t) + DONE_SUFFIX; }
function isAllowed(t){ return patient && String(patient[colFor(t)]||"").toLowerCase()==="sim"; }
function statusOf(t){
  if(!isAllowed(t)) return "oculto";
  const done = String(patient[doneColFor(t)]||"").toLowerCase()==="sim";
  return done ? "preenchido" : "ja";
}

/* URL para preencher: form_url > TEST_URLS > BASE_TEST_URL/<code>.html + ?token= */
function resolveFillUrl(t){
  const base =
    t.form_url ||
    TEST_URLS[t.code] ||
    `${BASE_TEST_URL}/${encodeURIComponent(String(t.code||"").toLowerCase())}.html`;
  return APPEND_TOKEN_PARAM ? buildUrl(base, { token: TOKEN }) : base;
}

/* URL de segunda-fonte: share_url > SHARE_URLS > BASE_FORM_URL/<code>.html + ?cpf=...&source=... (sem token) */
function resolveShareUrl(t, target){
  const base =
    t.share_url ||
    SHARE_URLS[t.code] ||
    `${BASE_FORM_URL}/${encodeURIComponent(String(t.code||"").toLowerCase())}.html`;
  return buildUrl(base, { cpf: onlyDigits(patient.cpf||""), source: target });
}

function normalizeSource(raw){
  const s = (raw||'').toString().toLowerCase()
    .normalize('NFD').replace(/\p{Diacritic}/gu,'').trim();

  // Paciente
  if (/\b(pac(iente)?|autorrelato)\b/.test(s)) 
    return { cls:'paciente', label:'Paciente' };

  // Pais / Cuidadores / Responsáveis
  if (/\b(pais|pai|mae|mae|cuidador(a)?|responsavel)\b/.test(s)) 
    return { cls:'pais', label:'Pais/Cuidadores' };

  // Profissional (CHECAR ANTES de professores)
  if (/\b(profiss(ional)?|avaliador(a)?|psico(logo|loga)?|neuropsico(logo|loga)?|terapeuta)\b/.test(s)) 
    return { cls:'profissional', label:'Profissional' };

  // Professores / Docentes / Escola
  if (/\b(professor(es)?|docente(s)?|escola)\b/.test(s)) 
    return { cls:'professores', label:'Professores' };

  // Familiares / Amigos
  if (/\b(familia(res)?|amig(o|a|os|as))\b/.test(s)) 
    return { cls:'familiares', label:'Familiares/Amigos' };

  // Fallback
  return { cls:'profissional', label: raw || 'Profissional' };
}


function toggleSections(showTests){
  const secResp = document.getElementById("respondentsSection");
  const secTests = document.getElementById("testsSection");
  if(showTests){ secResp.classList.add("hidden"); secTests.classList.remove("hidden"); }
  else{ secResp.classList.remove("hidden"); secTests.classList.add("hidden"); }
}

function openForSource(cls,label){
  currentSource = cls;
  currentSourceLabel = label;
  document.getElementById("selResp").textContent = label;
  toggleSections(true);
  renderTests();   // renderiza já filtrado
}

function backToRespondents(){
  currentSource = null;
  currentSourceLabel = "—";
  toggleSections(false);
}

document.getElementById("btnTrocarResp").addEventListener("click", backToRespondents);

/* monta os 4 cards de respondentes com contagem de formulários liberados */
function renderRespondentCards(){
  const grid = document.getElementById("sourcesGrid");
  grid.innerHTML = "";

  // 1. Pego todos os testes liberados pra este paciente
  const allowed = testsCatalog.filter(t => isAllowed(t));

  // 2. Contadores por tipo de respondente
  const counts = {
    paciente:     { total:0, done:0 },
    pais:         { total:0, done:0 },
    professores:  { total:0, done:0 },
    familiares:   { total:0, done:0 },
    profissional: { total:0, done:0 },
  };

  // 3. Preencho os contadores
  for (const t of allowed){
    const norm = normalizeSource(t.source).cls; // ex: "pais", "professores", etc.
    if (!counts[norm]) continue;

    counts[norm].total += 1;
    if (statusOf(t) === "preenchido"){
      counts[norm].done += 1;
    }
  }

  // 4. Crio os cards apenas pros tipos que têm formulário liberado
  for (const r of RESPONDENTS){
    const data = counts[r.cls] || { total:0, done:0 };

    // (3) Só renderiza se houver pelo menos 1 formulário pra esse respondente
    if (data.total === 0) continue;

    const finishedAll = (data.done === data.total && data.total > 0);

    const card  = el("div", { className:`resp-card src-${r.cls}` });
    const title = el("div", { className:"title", textContent:r.label });
    const desc  = el("div", { className:"desc",  textContent:r.desc });

    // (2) Linha com total e respondidos
    const count = el("div", {
      className:"count",
      textContent:`Disponíveis: ${data.total} • Respondidos: ${data.done}`
    });

    // (4) Botão muda texto e trava se já respondeu tudo
    const btn = el("button", {
      className:`resp-btn ${r.cls}`,
      textContent: finishedAll ? "Formulários preenchidos" : "Abrir formulários",
      disabled: finishedAll
    });

    if (!finishedAll){
      btn.addEventListener("click", ()=> openForSource(r.cls, r.label));
    }

    card.appendChild(title);
    card.appendChild(desc);
    card.appendChild(count);
    card.appendChild(btn);
    grid.appendChild(card);
  }
}


function renderTests(){
  const grid = $("#testsGrid");
  grid.innerHTML = "";
  if(!patient){ grid.innerHTML = "<p class='muted'>Nenhum dado carregado.</p>"; return; }

  // precisa ter escolhido um respondente
  if(!currentSource){ return; }

  const list = testsCatalog.filter(t => {
    if(!isAllowed(t)) return false;
    const src = normalizeSource(t.source).cls;
    return src === currentSource;
  });

  if(!list.length){
    grid.innerHTML = "<p class='muted'>Não há formulários para este respondente.</p>";
    return;
  }

  for(const t of list){
    const st  = statusOf(t); // "preenchido" | "ja"
    const src = normalizeSource(t.source);

    const card = el("div", {className:`test src-${src.cls}`});
    const head = el("div", {className:"test-head"});
    const titleWrap = el("div", {style:"min-width:0"});

    const title = el("div", {className:"test-title", textContent: t.label});
    const code  = el("div", {className:"test-code",  textContent: t.code});
    titleWrap.appendChild(title);
    titleWrap.appendChild(code);

    const srcChip = el("span", { className:`srcchip ${src.cls}`, textContent:src.label });
    const tag = el("span", {
      className:"tag " + (st==="preenchido" ? "preenchido" : "ja"),
      textContent:(st==="preenchido" ? "Preenchido" : (t.shareable ? "Aguardando envio" : "Pendente!"))
    });

    head.appendChild(titleWrap);
    head.appendChild(srcChip);
    head.appendChild(tag);
    card.appendChild(head);

    const actions = el("div", {className:"toolbar"});

    if (t.shareable) {
      if (st === "preenchido") {
        actions.appendChild(el("button", { className:"btn sec", textContent:"Preenchido", disabled:true }));
      } else {
        const btnShare = el("button", { className:`btn btn-src-${src.cls}`, textContent:"Enviar link" });
        btnShare.addEventListener("click", async ()=>{
          const shareUrl = resolveFillUrl(t); // mesmo link do Preencher (com ?token=)
          const ok = await navigator.clipboard.writeText(shareUrl).then(()=>true).catch(()=>false);
          if (ok) {
            setMsg(`Link copiado. Aguardando preenchimento de "${t.label}".`, "warn");
            tag.textContent = "Aguardando preenchimento";
            tag.className = "tag aguardando";
            setTimeout(()=>setMsg(""), 3500);
          } else {
            alert(shareUrl);
          }
        });
        actions.appendChild(btnShare);
      }
    } else {
      if (st === "preenchido") {
        actions.appendChild(el("button", {className:"btn sec", textContent:"Preenchido", disabled:true}));
      } else {
        const btnPre = el("button", {className:`btn btn-src-${src.cls}`, textContent:"Preencher"});
        btnPre.addEventListener("click", ()=> window.open(resolveFillUrl(t), "_blank"));
        actions.appendChild(btnPre);
      }
    }

    card.appendChild(actions);
    grid.appendChild(card);
  }
}

/* diálogo simples para escolher o alvo do link */
function chooseTarget(targets){
  return new Promise((resolve)=>{
    if(!targets || !targets.length){ resolve(null); return; }
    const label = "Para quem é esse link?\n" + targets.map((t,i)=>`${i+1}) ${t}`).join("\n") + "\n\nDigite o número:";
    const ans = prompt(label);
    if(!ans) return resolve(null);
    const idx = parseInt(ans,10)-1;
    if(isNaN(idx) || idx<0 || idx>=targets.length) return resolve(null);
    resolve(targets[idx]);
  });
}
</script>
</body>
</html>
