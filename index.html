<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Área do Paciente — Integrada Neuropsicologia</title>
  <meta name="description" content="Portal do paciente para acessar e preencher testes liberados."/>
  <style>
    :root{
      --bg:#0e1625; --card:#14213b; --line:#2b3f66;
      --text:#f8fafc; --muted:#cbd5e1;
      --pri:#6d28d9; --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
      --chip:#0b1220;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .wrap{max-width:980px;margin:20px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:18px}
    .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;gap:8px}
    .brand{font-weight:700;overflow-wrap:anywhere}
    h1,h2{margin:0 0 12px}
    h2{font-size:1.05rem;color:var(--muted)}
    .btn{display:inline-flex;align-items:center;gap:10px;background:var(--pri);border:none;color:#fff;padding:12px 16px;border-radius:12px;cursor:pointer;font-weight:600}
    .btn.sec{background:#334155}
    .btn.ok{background:var(--ok)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
    .msg{margin:12px 0;padding:12px;border-radius:10px}
    .okbox{background:#06351f;border:1px solid #0e6c45;color:#c8ffe3}
    .warnbox{background:#3a2903;border:1px solid #885e09;color:#ffe6b0}
    .errbox{background:#3b0d0d;border:1px solid #7f1d1d;color:#ffd5d5}

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;margin-top:10px}
    @media (max-width:560px){ .grid{grid-template-columns:1fr} }
    .test{background:rgba(0,0,0,.18);border:1px solid var(--line);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:10px;min-width:0}
    .test-head{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:start;min-width:0}
    @media (max-width:560px){ .test-head{grid-template-columns:1fr} }
    .test-title{font-weight:700;overflow-wrap:anywhere;word-break:break-word;min-width:0}
    .test-code{color:var(--muted);font-size:.9rem;overflow-wrap:anywhere}
    .tag{justify-self:start;font-size:.75rem;padding:2px 8px;border-radius:999px;border:1px solid var(--line);color:#dbeafe;white-space:nowrap}
    .tag.ja{background:#0b3d2a;border-color:#0e6c45}
    .tag.preenchido{background:#0a2b45;border-color:#145a86}
    .hidden{display:none !important}

    .grid-info{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:12px 0 6px}
    @media (max-width:720px){ .grid-info{grid-template-columns:1fr} }
    .info{background:rgba(0,0,0,.18);border:1px solid var(--line);border-radius:12px;padding:12px}
    .info b{display:block;margin-bottom:4px;color:#e2e8f0}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">Integrada Neuropsicologia — Área do Paciente</div>
      <div>
        <button id="btnSair" class="btn sec hidden">Sair</button>
      </div>
    </div>

    <!-- AVISOS -->
    <div id="msg" class="msg hidden"></div>

    <!-- APP -->
    <section id="viewApp" class="card hidden">
      <h1>Olá, <span id="pacNomeSpan">Paciente</span></h1>

      <!-- Dados do paciente -->
      <div class="grid-info" id="pacInfo" style="margin:10px 0 6px;"></div>

      <div class="toolbar">
        <button id="btnAtualizar" class="btn sec">Atualizar</button>
        <span id="resume" class="tag">—</span>
      </div>

      <h2>Seus testes liberados</h2>
      <div id="testsGrid" class="grid" aria-live="polite"></div>
    </section>
  </div>

<script>
/* ===========================
 * CONFIG
 * =========================== */
const SHEETDB_BASE = "https://sheetdb.io/api/v1/8pmdh33s9fvy8";
const SHEETS = { TESTS:"Tests", PATIENTS:"Patients", TOKENS:"LinkTokens" };

/* Fallbacks (se a aba Tests não trouxer URL) */
const BASE_TEST_URL = "https://integradaneuropsicologia.github.io/formularios"; // abre BASE_TEST_URL/<code>.html
const BASE_FORM_URL = "https://integradaneuropsicologia.github.io/formularios/share";

/* Mapa opcional para sobrescrever URLs por código (opcional) */
const TEST_URLS = {
  // "BAI": "https://integradaneuropsicologia.github.io/formularios/bai.html",
};
const SHARE_URLS = {
  // "SRS2": "https://.../srs2-share.html"
};

/* Links de “Preencher” levam token; links de segunda-fonte NÃO levam token */
const APPEND_TOKEN_PARAM = true;
const DEFAULT_TARGETS = ["pais","professores","segunda_fonte","heterorrelato"];

const TEST_PREFIX = "";       // se tiver prefixo nas colunas da Patients
const DONE_SUFFIX  = "_FEITO";

/* ===========================
 * HELPERS
 * =========================== */
const $ = s => document.querySelector(s);
const el = (tag, opts={}) => Object.assign(document.createElement(tag), opts);
const onlyDigits = s => (s||"").replace(/\D+/g,"");
const qs = k => new URLSearchParams(location.search).get(k) || "";

function setMsg(text="", type="ok"){
  const b = $("#msg");
  b.textContent = text;
  b.className = "msg " + (type==="ok"?"okbox":type==="warn"?"warnbox":"errbox");
  text ? b.classList.remove("hidden") : b.classList.add("hidden");
}
async function sheetSearch(sheet, params){
  const usp = new URLSearchParams(params);
  const url = `${SHEETDB_BASE}/search?sheet=${encodeURIComponent(sheet)}&${usp.toString()}`;
  const r = await fetch(url);
  if(!r.ok) throw new Error("Falha ao buscar em "+sheet);
  return r.json();
}
function maskCPF(cpf){
  const d = onlyDigits(cpf||"");
  if(d.length!==11) return cpf||"";
  return `${d.slice(0,3)}.${d.slice(3,6)}.${d.slice(6,9)}-${d.slice(9)}`;
}
function fmtDateISO(iso){
  if(!iso) return "";
  const [y,m,d] = iso.split("-");
  return (y && m && d) ? `${d}/${m}/${y}` : iso;
}
function buildUrl(base, params){
  try{
    const u = new URL(base, location.href);
    Object.entries(params||{}).forEach(([k,v])=> u.searchParams.set(k, v));
    return u.toString();
  }catch(_){
    const q = Object.entries(params||{}).map(([k,v])=>`${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join("&");
    return base + (base.includes("?") ? "&" : "?") + q;
  }
}

/* ===========================
 * ESTADO
 * =========================== */
let TOKEN = "";
let patient = null;
let testsCatalog = []; // {code,label,order,shareable,targets,form_url,share_url}

/* ===========================
 * BOOT VIA TOKEN
 * =========================== */
(async function boot(){
  try{
    TOKEN = qs("token");
    if(!TOKEN){ setMsg("Link inválido (sem token). Solicite um novo link ao consultório.", "err"); return; }

    // 1) validar token e obter CPF
    const trows = await sheetSearch(SHEETS.TOKENS, { token: TOKEN });
    if(!trows || !trows.length) throw new Error("Token inválido ou expirado.");
    const t = trows[0];
    if(String(t.disabled||"não").toLowerCase()==="sim") throw new Error("Token desativado. Peça um novo link.");
    if(t.expires_at && new Date(t.expires_at) < new Date()) throw new Error("Token expirado. Peça um novo link.");
    const cpf = onlyDigits(t.cpf||"");
    if(!cpf) throw new Error("Token sem CPF vinculado.");

    // 2) paciente
    const prows = await sheetSearch(SHEETS.PATIENTS, { cpf });
    if(!prows || !prows.length) throw new Error("Paciente não encontrado.");
    patient = prows[0];

    // 3) catálogo de testes
    await loadTests();

    // 4) render
    $("#pacNomeSpan").textContent = patient.nome || "Paciente";
    renderPatientInfo();
    renderTests();
    $("#viewApp").classList.remove("hidden");
    $("#btnSair").classList.remove("hidden");
    setMsg(""); // apaga avisos

  }catch(e){
    console.error(e);
    setMsg(e.message || "Falha ao abrir sua área. Tente novamente mais tarde.", "err");
  }
})();

$("#btnSair").addEventListener("click", ()=>{
  // remove o token da barra e recarrega
  history.replaceState({}, "", location.pathname);
  location.reload();
});

/* ===========================
 * INFO DO PACIENTE
 * =========================== */
function renderPatientInfo(){
  const g = $("#pacInfo");
  g.innerHTML = "";
  const info = [
    ["Nome", patient.nome || "-"],
    ["CPF",  maskCPF(patient.cpf)],
    ["Nascimento", fmtDateISO(patient.data_nascimento)],
    ["E-mail", patient.email || "-"],
    ["WhatsApp", patient.whatsapp || "-"],
  ];
  for(const [k,v] of info){
    const it = el("div",{className:"info"});
    it.innerHTML = `<b>${k}</b><div>${v||"-"}</div>`;
    g.appendChild(it);
  }
}

/* ===========================
 * TESTES
 * =========================== */
$("#btnAtualizar").addEventListener("click", async ()=>{
  if(!patient) return;
  try{
    const prows = await sheetSearch(SHEETS.PATIENTS, { cpf: patient.cpf });
    if(prows && prows.length) patient = prows[0];
    await loadTests(true);
    renderTests();
    setMsg("Atualizado.", "ok");
    setTimeout(()=>setMsg(""), 900);
  }catch(_){ /* silencia */ }
});

async function loadTests(skipFetch){
  if(!skipFetch){
    const rows = await sheetSearch(SHEETS.TESTS, { active:"sim" });
    testsCatalog = rows.map(r=>{
      const code = (r.code||"").trim();
      const label = (r.label||code).trim();
      const order = Number(r.order||9999);
      const shareable = String(r.shareable||"não").trim().toLowerCase()==="sim";
      const targetsArr = String(r.targets||"").split(/[;,]+/).map(s=>s.trim().toLowerCase()).filter(Boolean);
      const form_url = (r.form_url||"").trim();
      const share_url = (r.share_url||"").trim();
      return {
        code, label, order, shareable,
        targets: (shareable ? (targetsArr.length?targetsArr:DEFAULT_TARGETS) : []),
        form_url, share_url
      };
    }).filter(t=>t.code).sort((a,b)=> a.order-b.order || a.label.localeCompare(b.label));
  }
  const allowed = testsCatalog.filter(t => isAllowed(t));
  const cJa  = allowed.filter(t => statusOf(t)==="ja").length;
  const cOk  = allowed.filter(t => statusOf(t)==="preenchido").length;
  $("#resume").textContent = `Liberados: ${allowed.length} • Em aberto: ${cJa} • Preenchidos: ${cOk}`;
}

function colFor(t){ return (TEST_PREFIX ? TEST_PREFIX + t.code : t.code); }
function doneColFor(t){ return colFor(t) + DONE_SUFFIX; }
function isAllowed(t){ return patient && String(patient[colFor(t)]||"").toLowerCase()==="sim"; }
function statusOf(t){
  if(!isAllowed(t)) return "oculto";
  const done = String(patient[doneColFor(t)]||"").toLowerCase()==="sim";
  return done ? "preenchido" : "ja";
}

/* URL para preencher: form_url > TEST_URLS > BASE_TEST_URL/<code>.html + ?token= */
function resolveFillUrl(t){
  const base =
    t.form_url ||
    TEST_URLS[t.code] ||
    `${BASE_TEST_URL}/${encodeURIComponent(String(t.code||"").toLowerCase())}.html`;
  return APPEND_TOKEN_PARAM ? buildUrl(base, { token: TOKEN }) : base;
}

/* URL de segunda-fonte: share_url > SHARE_URLS > BASE_FORM_URL/<code>.html + ?cpf=...&source=... (sem token) */
function resolveShareUrl(t, target){
  const base =
    t.share_url ||
    SHARE_URLS[t.code] ||
    `${BASE_FORM_URL}/${encodeURIComponent(String(t.code||"").toLowerCase())}.html`;
  return buildUrl(base, { cpf: onlyDigits(patient.cpf||""), source: target });
}

function renderTests(){
  const grid = $("#testsGrid");
  grid.innerHTML = "";
  if(!patient){ grid.innerHTML = "<p class='muted'>Nenhum dado carregado.</p>"; return; }

  const list = testsCatalog.filter(t => isAllowed(t));
  if(!list.length){ grid.innerHTML = "<p class='muted'>Você ainda não possui testes liberados.</p>"; return; }

  for(const t of list){
    const st = statusOf(t);

    const card = el("div", {className:"test"});
    const head = el("div", {className:"test-head"});
    const titleWrap = el("div", {style:"min-width:0"});
    const title = el("div", {className:"test-title", textContent:t.label});
    const code  = el("div", {className:"test-code", textContent:t.code});
    titleWrap.appendChild(title); titleWrap.appendChild(code);

    const tag = el("span", {
      className:"tag "+(st==="preenchido"?"preenchido":"ja"),
      textContent:(st==="preenchido"?"preenchido":"Pendente!")
    });

    head.appendChild(titleWrap);
    head.appendChild(tag);
    card.appendChild(head);

    const actions = el("div", {className:"toolbar"});

    if(st==="preenchido"){
      actions.appendChild(el("button", {className:"btn sec", textContent:"Preenchido", disabled:true}));
    }else{
      const btnPre = el("button", {className:"btn ok", textContent:"Preencher"});
      btnPre.addEventListener("click", ()=> window.open(resolveFillUrl(t), "_blank"));
      actions.appendChild(btnPre);
    }

    if(t.shareable){
      const btnShare = el("button", {className:"btn sec", textContent:"Enviar link"});
      btnShare.addEventListener("click", async ()=>{
        const tgt = await chooseTarget(t.targets);
        if(!tgt) return;
        const shareUrl = resolveShareUrl(t, tgt);
        const ok = await navigator.clipboard.writeText(shareUrl).then(()=>true).catch(()=>false);
        alert(ok ? "Link copiado! Cole no WhatsApp." : shareUrl);
      });
      actions.appendChild(btnShare);
    }

    card.appendChild(actions);
    grid.appendChild(card);
  }
}

/* diálogo simples para escolher o alvo do link */
function chooseTarget(targets){
  return new Promise((resolve)=>{
    if(!targets || !targets.length){ resolve(null); return; }
    const label = "Para quem é esse link?\n" + targets.map((t,i)=>`${i+1}) ${t}`).join("\n") + "\n\nDigite o número:";
    const ans = prompt(label);
    if(!ans) return resolve(null);
    const idx = parseInt(ans,10)-1;
    if(isNaN(idx) || idx<0 || idx>=targets.length) return resolve(null);
    resolve(targets[idx]);
  });
}
</script>
</body>
</html>
