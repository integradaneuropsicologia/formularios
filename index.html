<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Área do Paciente — Integrada Neuropsicologia</title>
  <meta name="description" content="Portal do paciente para acessar e preencher testes liberados."/>
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb;
      --pri:#4f46e5; --ok:#22c55e; --warn:#f59e0b; --line:#1f2937; --err:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    .wrap{max-width:960px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:18px}
    .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;gap:8px}
    .brand{font-weight:700;overflow-wrap:anywhere}
    h1,h2{margin:0 0 12px}
    h2{font-size:1.05rem;color:var(--muted)}
    .btn{display:inline-flex;align-items:center;gap:8px;background:var(--pri);border:none;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn.sec{background:#334155}
    .btn.ok{background:var(--ok)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
    .msg{margin:10px 0;padding:10px;border-radius:8px}
    .msg.ok{background:#052e1a;color:#b3f7c1;border:1px solid #114d2a}
    .msg.err{background:#3b0d0d;color:#ffd0d0;border:1px solid #5b1919}
    .msg.warn{background:#3a2903;color:#ffe6b0;border:1px solid #5c4307}

    /* cartão de dados do paciente */
    .pac-card{display:grid;grid-template-columns:1fr;gap:10px}
    .pac-name{font-size:1.15rem;font-weight:800}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{font-size:.8rem;padding:4px 10px;border-radius:999px;border:1px solid var(--line);background:#0b1220;color:#cbd5e1}
    .chip b{color:#e5e7eb;font-weight:700}

    /* grid de testes */
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;margin-top:10px}
    @media (max-width:560px){ .grid{grid-template-columns:1fr} }
    .test{background:#0b1220;border:1px solid var(--line);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:10px;min-width:0}
    .test-head{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:start;min-width:0}
    .test-title{font-weight:700;overflow-wrap:anywhere;word-break:break-word;min-width:0}
    .test-code{color:var(--muted);font-size:.9rem;overflow-wrap:anywhere}
    .tag{justify-self:start;font-size:.75rem;padding:2px 8px;border-radius:999px;border:1px solid var(--line);color:var(--muted);white-space:nowrap}
    .tag.ja{background:#09331b;color:#9af0b1;border-color:#124d29}
    .tag.preenchido{background:#07263a;color:#b9e7ff;border-color:#0a3c66}
    .hidden{display:none !important}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">Integrada Neuropsicologia — Área do Paciente</div>
      <div><button id="btnSair" class="btn sec hidden">Sair</button></div>
    </div>

    <!-- STATUS / ERROS -->
    <div id="statusBox" class="msg warn">Carregando…</div>

    <!-- APP -->
    <section id="viewApp" class="card hidden">
      <h1>Olá, <span id="pacNomeSpan">Paciente</span></h1>

      <!-- DADOS DO PACIENTE (DESTAQUE) -->
      <div class="pac-card" id="pacCard">
        <div class="pac-name" id="pacNameBig">—</div>
        <div class="chips" id="pacChips"><!-- chips de dados entram aqui --></div>
      </div>

      <div class="toolbar">
        <button id="btnAtualizar" class="btn sec">Atualizar</button>
        <span id="resume" class="chip">—</span>
      </div>

      <h2>Seus testes liberados</h2>
      <div id="testsGrid" class="grid" aria-live="polite"></div>
    </section>
  </div>

<script>
/* ===========================
   CONFIG
   =========================== */
const SHEETDB_BASE = "https://sheetdb.io/api/v1/8pmdh33s9fvy8";
const SHEETS = { TESTS:"Tests", PATIENTS:"Patients", TOKENS:"LinkTokens" };

// Fallbacks/mapeamentos de URLs
const BASE_TEST_URL = "https://seu-dominio.com/testes"; // Preencher -> BASE_TEST_URL/<code>
const BASE_FORM_URL = "https://seu-dominio.com/form";   // Enviar link -> BASE_FORM_URL/<code>
const TEST_URLS  = { /* "BAI": "https://seus-formularios.com/bai" */ };
const SHARE_URLS = { /* "BAI": "https://seus-formularios.com/bai_share" */ };

// parâmetros que vão junto no link do teste
const APPEND_ID_PARAMS   = true;
const INCLUDE_NASC_PARAM = true;

const TEST_PREFIX = "";       // se usar prefixo nas colunas de teste na Patients
const DONE_SUFFIX = "_FEITO"; // coluna opcional <CODE>_FEITO = "sim"
const DEFAULT_TARGETS = ["pais","professores","segunda_fonte","heterorrelato"];

/* ===========================
   HELPERS
   =========================== */
const $ = s => document.querySelector(s);
const onlyDigits = s => (s||"").replace(/\D+/g,"");
const qs = k => new URLSearchParams(location.search).get(k) || "";
function setMsg(box, text, type="ok"){
  box.textContent = text;
  box.className = "msg "+type;
  text ? box.classList.remove("hidden") : box.classList.add("hidden");
}
function formatCPF(cpfDigits){
  const d = onlyDigits(cpfDigits||"").padEnd(11,"");
  if(d.length<11) return cpfDigits||"";
  return `${d.slice(0,3)}.${d.slice(3,6)}.${d.slice(6,9)}-${d.slice(9,11)}`;
}
function formatDateBR(iso){
  if(!iso) return "";
  const [y,m,d]=iso.split("-"); return `${d}/${m}/${y}`;
}
function buildUrl(base, params){
  try{
    const u = new URL(base, location.href);
    Object.entries(params||{}).forEach(([k,v])=> u.searchParams.set(k, v));
    return u.toString();
  }catch(_){
    const q = Object.entries(params||{}).map(([k,v])=>`${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join("&");
    return base + (base.includes("?") ? "&" : "?") + q;
  }
}

/* ===========================
   SHEETDB
   =========================== */
async function sheetSearch(sheet, params){
  const usp = new URLSearchParams(params);
  const url = `${SHEETDB_BASE}/search?sheet=${encodeURIComponent(sheet)}&${usp.toString()}`;
  const r = await fetch(url);
  if(!r.ok) throw new Error("Falha ao buscar em "+sheet);
  return r.json();
}

/* ===========================
   ESTADO
   =========================== */
let patient = null;    // linha Patients
let testsCatalog = []; // catálogo Tests

/* ===========================
   TOKEN LOGIN
   =========================== */
(async function autoLoginByToken(){
  const token = qs("token");
  const status = $("#statusBox");
  if(!token){
    setMsg(status, "Link inválido: token ausente. Solicite um novo link ao consultório.", "err");
    return;
  }
  try{
    // 1) validar token e obter CPF
    const rows = await sheetSearch(SHEETS.TOKENS, { token });
    if(!rows || !rows.length) throw new Error("Token inválido ou não encontrado.");
    const t = rows[0];

    // regras básicas (opcionais: ajuste conforme colunas)
    const disabled = String(t.disabled||"não").toLowerCase()==="sim";
    const expired  = t.expires_at && (new Date(t.expires_at) < new Date());
    if(disabled || expired) throw new Error("Token expirado ou desativado.");

    const cpf = onlyDigits(t.cpf||"");
    if(!cpf) throw new Error("Token sem CPF vinculado.");

    // 2) buscar paciente apenas por CPF
    const found = await sheetSearch(SHEETS.PATIENTS, { cpf });
    if(!found || !found.length) throw new Error("Paciente não encontrado. Contate o consultório.");
    patient = found[0];

    // 3) carregar catálogo e renderizar
    await loadTests();
    fillPatientHeader();
    renderTests();

    // mostrar app
    setMsg(status, "");
    $("#viewApp").classList.remove("hidden");
    $("#btnSair").classList.remove("hidden");
  }catch(e){
    setMsg(status, e.message || "Erro ao acessar. Tente novamente.", "err");
    console.error(e);
  }
})();

$("#btnSair").addEventListener("click", ()=>{
  patient=null; testsCatalog=[];
  $("#testsGrid").innerHTML="";
  $("#resume").textContent="—";
  $("#pacNomeSpan").textContent="Paciente";
  $("#pacNameBig").textContent="—";
  $("#pacChips").innerHTML="";
  $("#viewApp").classList.add("hidden");
  setMsg($("#statusBox"), "Sessão encerrada. Feche o navegador.", "ok");
});

$("#btnAtualizar").addEventListener("click", async ()=>{
  if(!patient) return;
  const cpf = onlyDigits(patient.cpf);
  const found = await sheetSearch(SHEETS.PATIENTS, { cpf });
  if(found && found.length) patient = found[0];
  await loadTests(true);
  fillPatientHeader();
  renderTests();
});

/* ===========================
   DADOS DO PACIENTE (DESTAQUE)
   =========================== */
function fillPatientHeader(){
  if(!patient) return;
  const nome = (patient.nome||"Paciente").trim();
  $("#pacNomeSpan").textContent = nome;
  $("#pacNameBig").textContent  = nome;

  const chips = $("#pacChips");
  chips.innerHTML = "";
  const addChip = (label, val) => {
    if(!val) return;
    const sp = document.createElement("span");
    sp.className="chip";
    sp.innerHTML = `<b>${label}:</b> ${val}`;
    chips.appendChild(sp);
  };

  addChip("CPF", formatCPF(patient.cpf));
  addChip("Nascimento", formatDateBR(patient.data_nascimento));
  addChip("E-mail", (patient.email||"").trim());
  addChip("WhatsApp", (patient.whatsapp||"").trim());
}

/* ===========================
   TESTES
   =========================== */
async function loadTests(skipFetch){
  if(!skipFetch){
    const rows = await sheetSearch(SHEETS.TESTS, {active:"sim"});
    testsCatalog = rows.map(r=>{
      const code = (r.code||"").trim();
      const label = (r.label||code).trim();
      const order = Number(r.order||9999);
      const shareable = String(r.shareable||"não").trim().toLowerCase()==="sim";
      // alvos que podem receber link compartilhável
      const targetsArr = String(r.targets||"")
        .split(/[;,]+/)
        .map(s=>s.trim().toLowerCase())
        .filter(Boolean);
      const form_url  = (r.form_url||"").trim();
      const share_url = (r.share_url||"").trim();
      return {
        code, label, order, shareable,
        targets: (shareable ? (targetsArr.length?targetsArr:DEFAULT_TARGETS) : []),
        form_url, share_url
      };
    }).filter(t=>t.code).sort((a,b)=> a.order-b.order || a.label.localeCompare(b.label));
  }

  // resumo
  const allowed = testsCatalog.filter(t => testAllowed(t));
  const cJa  = allowed.filter(t => testStatus(t)==="ja").length;
  const cOk  = allowed.filter(t => testStatus(t)==="preenchido").length;
  $("#resume").textContent = `Liberados: ${allowed.length} • Em aberto: ${cJa} • Preenchidos: ${cOk}`;
}

function colFor(t){ return (TEST_PREFIX ? TEST_PREFIX + t.code : t.code); }
function doneColFor(t){ return colFor(t) + DONE_SUFFIX; }

function testAllowed(t){
  if(!patient) return false;
  return String(patient[colFor(t)]||"").toLowerCase()==="sim";
}
function testStatus(t){
  if(!testAllowed(t)) return "oculto";
  const done = String(patient[doneColFor(t)]||"").toLowerCase()==="sim";
  return done ? "preenchido" : "ja";
}

// resolve URLs
function resolveFillUrl(t){
  const cpf  = onlyDigits(patient?.cpf||"");
  const nasc = patient?.data_nascimento || "";
  const base = t.form_url || TEST_URLS[t.code] || `${BASE_TEST_URL}/${encodeURIComponent(t.code)}`;
  if(!APPEND_ID_PARAMS) return base;
  const params = { cpf };
  if(INCLUDE_NASC_PARAM && nasc) params.nasc = nasc;
  return buildUrl(base, params);
}
function resolveShareUrl(t, target){
  const cpf  = onlyDigits(patient?.cpf||"");
  const base = t.share_url || SHARE_URLS[t.code] || `${BASE_FORM_URL}/${encodeURIComponent(t.code)}`;
  const params = { cpf, source: target };
  return buildUrl(base, params);
}

function renderTests(){
  const grid = $("#testsGrid");
  grid.innerHTML = "";
  if(!patient){ grid.innerHTML = "<p class='msg warn'>Nenhum dado carregado.</p>"; return; }

  const list = testsCatalog.filter(t => testAllowed(t));
  if(!list.length){ grid.innerHTML = "<p class='msg warn'>Você ainda não possui testes liberados.</p>"; return; }

  for(const t of list){
    const st = testStatus(t);

    const card = document.createElement("div");
    card.className = "test";

    const head = document.createElement("div");
    head.className = "test-head";

    const titleWrap = document.createElement("div");
    const title = document.createElement("div");
    title.className = "test-title";
    title.textContent = t.label;
    const code = document.createElement("div");
    code.className = "test-code";
    code.textContent = t.code;
    titleWrap.appendChild(title);
    titleWrap.appendChild(code);

    const tag = document.createElement("span");
    tag.className = "tag "+(st==="preenchido"?"preenchido":"ja");
    tag.textContent = (st==="preenchido" ? "preenchido" : "Pendente!");

    head.appendChild(titleWrap);
    head.appendChild(tag);
    card.appendChild(head);

    const actions = document.createElement("div");
    actions.className = "toolbar";

    if(st==="preenchido"){
      const btnDone = document.createElement("button");
      btnDone.className = "btn sec";
      btnDone.textContent = "Preenchido";
      btnDone.disabled = true;
      actions.appendChild(btnDone);
    }else{
      const btnPre = document.createElement("button");
      btnPre.className = "btn ok";
      btnPre.textContent = "Preencher";
      btnPre.addEventListener("click", ()=> window.open(resolveFillUrl(t), "_blank"));
      actions.appendChild(btnPre);
    }

    if(t.shareable){
      const btnShare = document.createElement("button");
      btnShare.className = "btn sec";
      btnShare.textContent = "Enviar link";
      btnShare.addEventListener("click", async ()=>{
        const tgt = await chooseTarget(t.targets);
        if(!tgt) return;
        const shareUrl = resolveShareUrl(t, tgt);
        let ok=false;
        try{
          await navigator.clipboard.writeText(shareUrl);
          ok=true;
        }catch(_){}
        alert(ok ? "Link copiado! Cole no WhatsApp." : shareUrl);
      });
      actions.appendChild(btnShare);
    }

    card.appendChild(actions);
    grid.appendChild(card);
  }
}

// prompt simples para escolher alvo do link
function chooseTarget(targets){
  return new Promise((resolve)=>{
    if(!targets || !targets.length){ resolve(null); return; }
    const label = "Para quem é esse link?\n" + targets.map((t,i)=>`${i+1}) ${t}`).join("\n") + "\n\nDigite o número:";
    const ans = prompt(label);
    if(!ans) return resolve(null);
    const idx = parseInt(ans,10)-1;
    if(isNaN(idx) || idx<0 || idx>=targets.length) return resolve(null);
    resolve(targets[idx]);
  });
}
</script>
</body>
</html>
