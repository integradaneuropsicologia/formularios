<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>EBADEP-A — Autorrelato</title>
<style>
  :root{
    --bg:#0e1625; --card:#14213b; --line:#2b3f66;
    --text:#f8fafc; --muted:#cbd5e1;
    --pri:#6d28d9; --ok:#10b981; --err:#ef4444; --warn:#f59e0b;
    --chip:#0b1220; --chipHover:#0f1a2e;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  .wrap{max-width:1024px;margin:20px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:18px}
  h1{margin:0 0 6px;font-size:1.45rem}
  .muted{color:var(--muted)}

  .grid-info{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:12px 0 6px}
  @media (max-width:720px){.grid-info{grid-template-columns:1fr}}
  .info{background:rgba(0,0,0,.18);border:1px solid var(--line);border-radius:12px;padding:12px}
  .info b{display:block;margin-bottom:4px;color:#e2e8f0}

  /* ===== ITENS ===== */
  .item{display:grid;grid-template-columns:1.25fr auto 1.25fr;gap:12px;align-items:center;border:1px solid var(--line);border-radius:12px;padding:12px;background:rgba(0,0,0,.18);margin-bottom:12px}
  .left{font-size:.98rem}
  .right{font-size:.98rem;text-align:right}
  .scale{display:grid;grid-template-columns:repeat(4, 38px);gap:10px;justify-content:center}

  /* radios estilizados como círculos (podem lembrar checkboxes) */
  .dot{position:relative;width:38px;height:38px;border-radius:999px;border:1px solid var(--line);background:var(--chip);display:grid;place-items:center;cursor:pointer;transition:transform .05s ease, border-color .15s ease, background .15s ease}
  .dot:hover{border-color:#4f70ff;background:var(--chipHover)}
  .dot input{appearance:none;-webkit-appearance:none;width:0;height:0;position:absolute;opacity:0}
  .bullet{width:16px;height:16px;border-radius:999px;border:2px solid #7aa2ff}
  .dot input:checked + .bullet{background:#7aa2ff}
  .dot:focus-within{outline:2px solid #7aa2ff; outline-offset:2px}

  @media (max-width:560px){
    .item{grid-template-columns:1fr auto 1fr}
    .left,.right{font-size:.95rem}
    .scale{grid-template-columns:repeat(4, 34px);gap:8px}
  }

  .legend{display:flex;flex-wrap:wrap;gap:8px;margin:6px 0 12px}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:rgba(0,0,0,.25);font-size:.86rem}

  /* Ações */
  .btn{display:inline-flex;align-items:center;gap:10px;background:var(--pri);border:none;color:#fff;padding:12px 16px;border-radius:12px;cursor:pointer;font-weight:600}
  .btn.ok{background:var(--ok)}
  .btn.ghost{background:transparent;border:1px solid var(--line);color:var(--muted)}
  .btn:disabled{opacity:.6;cursor:not-allowed}

  /* Mensagens */
  .msg{margin:12px 0;padding:12px;border-radius:10px}
  .okbox{background:#06351f;border:1px solid #0e6c45;color:#c8ffe3}
  .errbox{background:#3b0d0d;border:1px solid #7f1d1d;color:#ffd5d5}
  .warnbox{background:#3a2903;border:1px solid #885e09;color:#ffe6b0}

  /* Progresso */
  .progress{height:10px;background:rgba(255,255,255,.05);border:1px solid var(--line);border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0%;background:linear-gradient(90deg, #6d28d9, #10b981)}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>EBADEP-A</h1>
    <p class="muted">Responda pensando nas <b>últimas duas semanas, incluindo hoje</b>. Em cada linha há duas frases opostas. Marque um dos quatro círculos entre elas, indicando onde você se encontra no momento.</p>
    <div class="legend">
      <span class="pill">Mais próximo da frase da esquerda</span>
      <span class="pill">Leve tendência à esquerda</span>
      <span class="pill">Leve tendência à direita</span>
      <span class="pill">Mais próximo da frase da direita</span>
    </div>

    <div id="pacInfo" class="grid-info" style="display:none;"></div>

    <div id="progressWrap" style="display:none; gap:8px; align-items:center; margin:8px 0 0;">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:6px">
        <span class="muted" id="progressText">Progresso: 0/45</span>
        <button id="clearDraft" class="btn ghost" type="button" title="Limpar rascunho local">Limpar rascunho</button>
      </div>
      <div class="progress"><div class="bar" id="bar"></div></div>
    </div>

    <form id="form" style="margin-top:14px; display:none;" novalidate>
      <div id="qs"></div>
      <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
        <button id="btnSubmit" class="btn ok" type="submit">Enviar respostas</button>
        <button id="btnSave" class="btn ghost" type="button" title="Salvar rascunho">Salvar rascunho</button>
      </div>
      <div id="msg" class="msg" style="display:none" role="alert" aria-live="polite"></div>
    </form>

    <div id="alert" class="msg" style="display:none" role="alert" aria-live="assertive"></div>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const SHEETDB_BASE = "https://sheetdb.io/api/v1/8pmdh33s9fvy8";
const SHEETS = { PATIENTS:"Patients", TOKENS:"LinkTokens", SCORES:"Score_EBADEP_A" };
const CODE = "EBADEP_A";
const PORTAL_URL = "https://integradaneuropsicologia.github.io/formularios/";
/* Coluna(s) que liberam o formulário no sheet Patients */
const RELEASE_KEYS = ["EBADEP_A"]; // pode ajustar o nome da coluna na sua planilha

/* ===== HELPERS ===== */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const onlyDigits = s => (s||"").replace(/\D+/g,"");
const qs = k => new URLSearchParams(location.search).get(k) || "";
function setBox(id, text, kind="ok"){ const el=$(id); if(!el) return; el.textContent = text; el.className = "msg " + (kind==="ok"?"okbox":kind==="warn"?"warnbox":"errbox"); el.style.display = "block"; }
function hideBox(id){ const el=$(id); if(el){ el.style.display="none"; el.textContent=""; } }
function maskCPF(cpf){ const d = onlyDigits(cpf||""); if(d.length!==11) return cpf||""; return `${d.slice(0,3)}.${d.slice(3,6)}.${d.slice(6,9)}-${d.slice(9)}`; }
function fmtDateISO(iso){ if(!iso) return ""; const [y,m,d] = iso.split("-"); if(!y||!m||!d) return iso; return `${d}/${m}/${y}`; }
async function GET(url){ const r=await fetch(url); if(!r.ok) throw new Error("HTTP "+r.status); return r.json(); }
async function sheetSearch(sheet, params){ const usp = new URLSearchParams(params); return GET(`${SHEETDB_BASE}/search?sheet=${encodeURIComponent(sheet)}&${usp.toString()}`); }
async function sheetCreate(sheet, row){ const r = await fetch(`${SHEETDB_BASE}?sheet=${encodeURIComponent(sheet)}`, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ data:[row] }) }); if(!r.ok) throw new Error(await r.text()); return r.json(); }
async function sheetPatchBy(sheet, column, value, data){ const r = await fetch(`${SHEETDB_BASE}/${encodeURIComponent(column)}/${encodeURIComponent(value)}?sheet=${encodeURIComponent(sheet)}`, { method:"PATCH", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ data }) }); if(!r.ok) throw new Error(await r.text()); return r.json(); }
function goPortalWithToken(){ const TOKEN = qs("token"); try{ const u = new URL(PORTAL_URL, location.href); u.searchParams.set("token", TOKEN); location.href = u.toString(); }catch(_){ const sep = PORTAL_URL.includes("?") ? "&" : "?"; location.href = PORTAL_URL + sep + "token=" + encodeURIComponent(TOKEN); } }

/* ===== ITENS (45) ===== */
// Cada item: {left:"", right:""}. Edite os textos à vontade.
const ITEMS = [
  {left:"Não tenho vontade de chorar.", right:"Tenho sentido vontade de chorar."},
  {left:"Tenho me sentido muito bem.", right:"Tenho estado mais angustiado(a)."},
  {left:"Consigo realizar tarefas.", right:"Sinto-me mais impotente para realizar tarefas."},
  {left:"Resolvo meus problemas.", right:"Sinto-me menos capaz para enfrentar meus problemas."},
  {left:"Faço coisas que gosto.", right:"Não tenho mais vontade de fazer coisas que gostava."},
  {left:"Não tenho chorado.", right:"Tenho chorado."},
  {left:"Não sinto solidão.", right:"Sinto-me cada vez mais sozinho(a)."},
  {left:"Sei me comportar nas situações.", right:"Não sei mais como agir."},
  {left:"Consigo me virar sozinho(a).", right:"Não consigo mais me virar sozinho(a)."},
  {left:"O futuro será melhor.", right:"Não acredito que as coisas melhorem."},
  {left:"Minhas atitudes me parecem normais.", right:"Acho minhas atitudes menos adequadas do que antes."},
  {left:"Faço planos para o futuro.", right:"Não consigo planejar meu futuro."},
  {left:"Acredito em mim.", right:"Estou acreditando menos em mim."},
  {left:"Não tenho problemas para decidir.", right:"Está mais difícil decidir."},
  {left:"Escolho com facilidade.", right:"Não consigo mais escolher sozinho(a)."},
  {left:"Consigo fazer minhas tarefas sem ajuda.", right:"Estou precisando de ajuda para realizar meus trabalhos."},
  {left:"Sinto prazer em realizar minhas atividades.", right:"As coisas não me agradam como antigamente."},
  {left:"Sinto-me feliz com minha vida.", right:"Antes eu era mais feliz."},
  {left:"Acredito que as coisas estão indo bem na minha vida.", right:"Acredito que atualmente nada vai bem."},
  {left:"Faço coisas que ajudam os outros.", right:"As coisas que faço não ajudam a mais ninguém."},
  {left:"Estar com pessoas é bom.", right:"Comecei a inventar desculpas para não me encontrar com as pessoas."},
  {left:"Compareço a festas e reuniões quando sou convidado(a).", right:"Tenho evitado festas e reuniões, mesmo convidado(a)."},
  {left:"Consigo me concentrar nas minhas atividades.", right:"Não consigo mais me concentrar."},
  {left:"Tenho realizado minhas tarefas normalmente.", right:"Estou mais lento(a) para realizar minhas tarefas."},
  {left:"Tenho realizado minhas tarefas normalmente.", right:"Estou me sentindo mais agitado(a) do que antes."},
  {left:"Sempre achei minha vida boa.", right:"Hoje acho que meu passado não foi bom."},
  {left:"Sinto-me disposto(a).", right:"Logo pela manhã me sinto esgotado(a)."},
  {left:"Minha vida é boa.", right:"Minha vida está cada vez pior."},
  {left:"Morrer não é a solução para problemas.", right:"Tenho pensado que seria melhor estar morto(a)."},
  {left:"Acredito em mim.", right:"Não acredito mais em mim."},
  {left:"Durmo bem.", right:"Não consigo mais dormir a noite inteira."},
  {left:"Faço normalmente o que é necessário.", right:"Não consigo mais fazer o necessário."},
  {left:"Gosto muito da minha vida.", right:"Não dou mais valor à minha vida."},
  {left:"Gosto de mim.", right:"Não gosto mais de mim."},
  {left:"Termino minhas tarefas.", right:"Não termino mais minhas tarefas."},
  {left:"Estou tranquilo(a).", right:"Perco a paciência por muito pouco."},
  {left:"Não venho me sentindo nervoso(a).", right:"Qualquer coisa me deixa nervoso(a)."},
  {left:"Sinto-me com disposição.", right:"Ando mais cansado(a)."},
  {left:"Sinto-me disposto(a).", right:"Não tenho mais vontade de fazer as coisas."},
  {left:"Durmo normalmente.", right:"Tenho dormido muito."},
  {left:"Minha fome continua como sempre.", right:"Tenho comido menos."},
  {left:"Tenho desejo sexual como antes.", right:"Meu desejo sexual vem diminuindo muito."},
  {left:"Meu peso continua o mesmo.", right:"Tenho emagrecido sem fazer regime."},
  {left:"Tomo remédio apenas quando preciso.", right:"Gosto de tomar remédio por precaução."},
  {left:"Não costumo sentir culpa.", right:"Venho me sentindo culpado(a) pelos problemas."}
];

/* ===== RENDER ===== */
function renderQuestions(){
  const host = $("#qs"); host.innerHTML = "";
  ITEMS.forEach((it, idx)=>{
    const q = idx+1, qn = String(q).padStart(2,"0");
    const row = document.createElement('div');
    row.className = 'item';
    row.setAttribute('data-q', String(q));

    const left = document.createElement('div');
    left.className = 'left';
    left.id = `l${qn}`;
    left.textContent = `${q}. ${it.left}`;

    const mid = document.createElement('div');
    mid.className = 'scale';

    for(let val=0; val<=3; val++){
      const lab = document.createElement('label'); lab.className = 'dot'; lab.setAttribute('title', `Marcar ${val}`);
      const id = `q${qn}_${val}`;
      lab.innerHTML = `<input type="radio" name="q${qn}" id="${id}" value="${val}" required aria-labelledby="l${qn} r${qn}"><span class="bullet"></span>`;
      mid.appendChild(lab);
    }

    const right = document.createElement('div');
    right.className = 'right';
    right.id = `r${qn}`;
    right.textContent = it.right;

    row.append(left, mid, right);
    host.appendChild(row);
  });
}

/* ===== ESTADO ===== */
let patient=null, tokenRow=null, CPF="";
const TOKEN = qs("token");
const STORAGE_KEY = `EBADEP_A_${TOKEN||'anon'}`;

/* ===== BOOT ===== */
(async function boot(){
  try{
    if(!TOKEN){ setBox("#alert","Link inválido (sem token). Solicite um novo link.","err"); return; }

    const trows = await sheetSearch(SHEETS.TOKENS, { token: TOKEN });
    if(!trows || !trows.length) throw new Error("Token inválido ou expirado.");
    tokenRow = trows[0];
    if(String(tokenRow.disabled||"não").toLowerCase()==="sim") throw new Error("Token desativado. Peça um novo link.");
    if(tokenRow.expires_at && new Date(tokenRow.expires_at) < new Date()) throw new Error("Token expirado. Peça um novo link.");
    CPF = onlyDigits(tokenRow.cpf||"");
    if(!CPF) throw new Error("Token sem CPF vinculado.");

    const prows = await sheetSearch(SHEETS.PATIENTS, { cpf: CPF });
    if(!prows || !prows.length) throw new Error("Paciente não encontrado.");
    patient = prows[0];

    const isAllowed = RELEASE_KEYS.some(k => String(patient[k]||"").trim().toLowerCase()==="sim");
    if(!isAllowed){ setBox("#alert","Este formulário não está liberado para você.","err"); return; }

    // Já respondeu?
    const doneKeys = RELEASE_KEYS.map(k => `${k}_FEITO`);
    const anyDoneFlag = doneKeys.some(k => String(patient[k]||"").trim().toLowerCase()==="sim");
    const already = await sheetSearch(SHEETS.SCORES, { cpf: CPF, code: CODE });
    if(anyDoneFlag || (already && already.length)){
      setBox("#alert","Você já respondeu este formulário. Voltando ao portal…","ok");
      setTimeout(goPortalWithToken, 1200); return;
    }

    // Render
    renderPatientInfo();
    renderQuestions();
    restoreDraft();
    updateProgress();

    $("#pacInfo").style.display = "grid";
    $("#form").style.display = "block";
    $("#progressWrap").style.display = "block";
    hideBox("#alert");

    devChecks();

  }catch(err){
    console.error(err);
    setBox("#alert", err.message || "Falha ao abrir o formulário. Tente novamente mais tarde.", "err");
  }
})();

function renderPatientInfo(){
  const g = $("#pacInfo"); g.innerHTML="";
  const info = [
    ["Nome", patient.nome || "-"],
    ["CPF", maskCPF(patient.cpf)],
    ["Nascimento", fmtDateISO(patient.data_nascimento)],
    ["E-mail", patient.email || "-"],
    ["WhatsApp", patient.whatsapp || "-"]
  ];
  for(const [k,v] of info){
    const div = document.createElement("div");
    div.className = "info";
    div.innerHTML = `<b>${k}</b><div>${v||"-"}</div>`;
    g.appendChild(div);
  }
}

/* ===== RASCUNHO LOCAL ===== */
function saveDraft(){
  const data = {};
  for(let i=1;i<=ITEMS.length;i++){
    const qn = String(i).padStart(2,"0");
    const sel = document.querySelector(`input[name="q${qn}"]:checked`);
    if(sel) data[`q${qn}`] = Number(sel.value);
  }
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }catch(e){ console.warn("Sem espaço para salvar rascunho"); }
}
function restoreDraft(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    const data = JSON.parse(raw);
    for(const [k,v] of Object.entries(data||{})){
      const el = document.querySelector(`input[name="${k}"][value="${v}"]`);
      if(el){ el.checked = true; }
    }
  }catch(e){ /* ignore */ }
}
function clearDraft(){ localStorage.removeItem(STORAGE_KEY); }

function countAnswered(){ let c=0; for(let i=1;i<=ITEMS.length;i++){ const qn=String(i).padStart(2,'0'); if(document.querySelector(`input[name="q${qn}"]:checked`)) c++; } return c; }
function updateProgress(){ const answered = countAnswered(); const total = ITEMS.length; $("#progressText").textContent = `Progresso: ${answered}/${total}`; $("#bar").style.width = `${(answered/total)*100}%`; }

/* ===== EVENTOS DE UI ===== */
addEventListener('change', (e)=>{ if(e.target && e.target.matches('input[type="radio"][name^="q"]')){ saveDraft(); updateProgress(); } });
$("#btnSave").addEventListener('click', ()=>{ saveDraft(); setBox('#msg','Rascunho salvo neste dispositivo.','ok'); });
$("#clearDraft").addEventListener('click', ()=>{ clearDraft(); setBox('#msg','Rascunho apagado.','warn'); });

/* ===== SUBMIT ===== */
let sending=false;
$("#form").addEventListener("submit", async (e)=>{
  e.preventDefault(); if(sending) return; sending = true; hideBox("#msg");
  const btn = $("#btnSubmit"); const originalText = btn.textContent; btn.disabled = true; btn.textContent = "Enviando…";
  try{
    if(!patient) throw new Error("Sessão inválida. Recarregue o link.");

    // Coleta e soma (0..3 por item)
    let total = 0;
    for(let i=1;i<=ITEMS.length;i++){
      const qn = String(i).padStart(2,"0");
      const sel = document.querySelector(`input[name="q${qn}"]:checked`);
      if(!sel){
        const row = document.querySelector(`.item[data-q="${i}"]`);
        if(row) row.scrollIntoView({behavior:'smooth', block:'center'});
        throw new Error(`Responda a questão ${i}.`);
      }
      total += Number(sel.value);
    }

    await sheetCreate(SHEETS.SCORES, {
      result_id: `${patient.cpf}_${CODE}_${Date.now()}`,
      token: TOKEN,
      cpf: patient.cpf,
      code: CODE,
      source: "paciente",
      submitted_at: new Date().toISOString(),
      total: total,
      categoria: "",   // não utilizado neste teste
      metrics: ""      // não utilizado neste teste
    });

    // Marca como feito (se existir a coluna _FEITO)
    const doneUpdates = {};
    RELEASE_KEYS.map(k=>`${k}_FEITO`).forEach(k=>{ if(k in patient) doneUpdates[k] = "sim"; });
    if(Object.keys(doneUpdates).length===0) doneUpdates[`${RELEASE_KEYS[0]}_FEITO`] = "sim";
    await sheetPatchBy(SHEETS.PATIENTS, "cpf", patient.cpf, doneUpdates);

    clearDraft();
    setBox("#msg","Formulário enviado. Voltando ao portal…","ok");
    setTimeout(goPortalWithToken, 1100);

  }catch(err){
    console.error(err);
    setBox("#msg", err.message || "Falha ao enviar. Tente novamente.", "err");
    sending = false; btn.disabled = false; btn.textContent = originalText;
  }
});

/* ===== DEV CHECKS ===== */
function devChecks(){ if(ITEMS.length !== 45){ console.warn(`ITEMS possui ${ITEMS.length} itens, esperado 45.`); } }
</script>
</body>
</html>
